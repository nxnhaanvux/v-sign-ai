<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-Sign AI - Thu th·∫≠p D·ªØ li·ªáu (FIXED)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #e63946;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .alert-critical {
            background: #fee;
            border: 3px solid #e63946;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .alert-critical h3 {
            color: #e63946;
            margin-bottom: 10px;
        }
        
        .gesture-guide {
            background: #f0f7ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .gesture-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .gesture-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .gesture-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .gesture-card.selected {
            background: #667eea;
            color: white;
        }
        
        .gesture-card .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .gesture-card .name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .setup-section {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .video-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .instructions-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
        }
        
        .controls {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
        }
        
        .status {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .status-value {
            font-weight: 600;
            color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        
        .countdown {
            font-size: 72px;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }
        
        .samples-list {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }
        
        .sample-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sample-item.completed {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        @media (max-width: 768px) {
            .video-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ü V-Sign AI - Thu th·∫≠p D·ªØ li·ªáu TH·∫¨T</h1>
        <p class="subtitle">‚úÖ FIXED: ƒê∆∞·ªùng x∆∞∆°ng ch√≠nh x√°c nh∆∞ MediaPipe official</p>
        
        <div class="alert-critical">
            <h3>üö® QUAN TR·ªåNG:</h3>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>Version n√†y s·ª≠ d·ª•ng <strong>MediaPipe Drawing Utils CH√çNH TH·ª®C</strong></li>
                <li>ƒê∆∞·ªùng x∆∞∆°ng (connections) gi·ªëng 100% v·ªõi MediaPipe official</li>
                <li>M√†u xanh l√° chu·∫©n, ƒë·ªô d√†y ƒë∆∞·ªùng chu·∫©n</li>
            </ul>
        </div>

        <!-- Gesture Selection -->
        <div class="gesture-guide">
            <h3>üìö CH·ªåN K√ù HI·ªÜU C·∫¶N THU TH·∫¨P</h3>
            <div class="gesture-cards">
                <div class="gesture-card" onclick="selectGesture('ƒêau', this)">
                    <div class="icon">üò£</div>
                    <div class="name">ƒêau</div>
                </div>
                <div class="gesture-card" onclick="selectGesture('B√°c_sƒ©', this)">
                    <div class="icon">üë®‚Äç‚öïÔ∏è</div>
                    <div class="name">B√°c sƒ©</div>
                </div>
                <div class="gesture-card" onclick="selectGesture('C·∫ßn_gi√∫p', this)">
                    <div class="icon">üÜò</div>
                    <div class="name">C·∫ßn gi√∫p</div>
                </div>
                <div class="gesture-card" onclick="selectGesture('Thu·ªëc', this)">
                    <div class="icon">üíä</div>
                    <div class="name">Thu·ªëc</div>
                </div>
                <div class="gesture-card" onclick="selectGesture('C·∫£m_∆°n', this)">
                    <div class="icon">üôè</div>
                    <div class="name">C·∫£m ∆°n</div>
                </div>
            </div>
        </div>
        
        <!-- Setup -->
        <div class="setup-section">
            <h3 style="margin-bottom: 15px;">‚öôÔ∏è C·∫•u h√¨nh</h3>
            <div class="input-group">
                <label>K√Ω hi·ªáu ƒë√£ ch·ªçn:</label>
                <input type="text" id="gestureName" readonly placeholder="Ch·ªçn k√Ω hi·ªáu ·ªü tr√™n">
            </div>
            <div class="input-group">
                <label>ID ng∆∞·ªùi th·ª±c hi·ªán:</label>
                <input type="text" id="personId" value="person1">
            </div>
            <div class="input-group">
                <label>S·ªë l∆∞·ª£ng m·∫´u:</label>
                <input type="number" id="targetSamples" value="100" min="50" max="200">
            </div>
        </div>
        
        <!-- Video Section -->
        <div class="video-section">
            <div class="video-container">
                <video id="webcam" autoplay></video>
                <canvas id="canvas"></canvas>
                <div class="instructions-overlay" id="instructions">
                    üëÜ Nh·∫•n "B·∫Øt ƒë·∫ßu Camera"
                </div>
            </div>
            
            <div class="controls">
                <div class="status">
                    <h4 style="margin-bottom: 10px;">üìä Tr·∫°ng th√°i</h4>
                    <div class="status-item">
                        <span>Camera:</span>
                        <span class="status-value" id="cameraStatus">Ch∆∞a k·∫øt n·ªëi</span>
                    </div>
                    <div class="status-item">
                        <span>Tay:</span>
                        <span class="status-value" id="handStatus">Kh√¥ng</span>
                    </div>
                    <div class="status-item">
                        <span>M·∫´u:</span>
                        <span class="status-value"><span id="currentSamples">0</span>/<span id="targetDisplay">100</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
                
                <div id="countdown" class="countdown" style="display: none;">3</div>
                
                <button class="btn-primary" id="startCameraBtn" onclick="startCamera()">
                    üìπ B·∫Øt ƒë·∫ßu Camera
                </button>
                
                <button class="btn-success" id="recordBtn" onclick="startRecording()" disabled>
                    üî¥ Ghi M·∫´u
                </button>
                
                <button class="btn-primary" id="downloadBtn" onclick="downloadData()" disabled>
                    üíæ Download Dataset
                </button>
                
                <button class="btn-danger" onclick="resetData()">
                    üóëÔ∏è Reset
                </button>
            </div>
        </div>
        
        <!-- Samples List -->
        <div>
            <h3>üìã Danh s√°ch M·∫´u</h3>
            <div class="samples-list" id="samplesList">
                <p style="text-align: center; color: #999; padding: 20px;">
                    Ch∆∞a c√≥ m·∫´u n√†o...
                </p>
            </div>
        </div>
    </div>

    <script>
        let hands;
        let camera;
        let isRecording = false;
        let currentFrames = [];
        let allSamples = [];
        let sequenceCount = 0;
        let selectedGesture = '';
        
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Select gesture
        function selectGesture(gestureName, element) {
            selectedGesture = gestureName;
            document.getElementById('gestureName').value = gestureName;
            
            document.querySelectorAll('.gesture-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');
            
            document.getElementById('instructions').innerHTML = 
                `<strong>ƒêang thu: ${gestureName}</strong>`;
        }
        
        // Initialize MediaPipe Hands
        async function initializeHands() {
            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });
            
            hands.setOptions({
                maxNumHands: 2,  // CH·ªà 1 TAY
                modelComplexity: 1,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.7
            });
            
            hands.onResults(onResults);
        }
        
        // Start camera
        async function startCamera() {
            if (!selectedGesture) {
                alert('‚ö†Ô∏è Vui l√≤ng CH·ªåN K√ù HI·ªÜU tr∆∞·ªõc!');
                return;
            }
            
            try {
                await initializeHands();
                
                camera = new Camera(video, {
                    onFrame: async () => {
                        await hands.send({ image: video });
                    },
                    width: 640,
                    height: 480
                });
                
                await camera.start();
                
                canvas.width = 640;
                canvas.height = 480;
                
                document.getElementById('cameraStatus').textContent = 'K·∫øt n·ªëi ‚úì';
                document.getElementById('cameraStatus').style.color = '#48bb78';
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('recordBtn').disabled = false;
                
            } catch (error) {
                alert('L·ªói camera: ' + error.message);
            }
        }
        
        // Process hand results - S·ª¨ D·ª§NG MEDIAPIPE DRAWING UTILS CH√çNH TH·ª®C
        function onResults(results) {
            // Clear canvas
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // V·∫Ω video l√™n canvas (optional - ƒë·ªÉ debug)
            // ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            
            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    // S·ª¨ D·ª§NG MEDIAPIPE DRAWING UTILS - CHU·∫®N 100%
                    drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {
                        color: '#00FF00',
                        lineWidth: 5
                    });
                    
                    drawLandmarks(ctx, landmarks, {
                        color: '#FF0000',
                        lineWidth: 2,
                        radius: 4
                    });
                }
            }
            
            ctx.restore();
            
            // Update status
            const handDetected = results.multiHandLandmarks && results.multiHandLandmarks.length > 0;
            document.getElementById('handStatus').textContent = handDetected ? 'C√≥ ‚úì' : 'Kh√¥ng';
            document.getElementById('handStatus').style.color = handDetected ? '#48bb78' : '#f56565';
            
            // Capture frame if recording
            if (isRecording && handDetected) {
                captureFrame(results.multiHandLandmarks[0]);
            }
        }
        
        // Start recording
        async function startRecording() {
            if (!selectedGesture) {
                alert('‚ö†Ô∏è Vui l√≤ng CH·ªåN K√ù HI·ªÜU!');
                return;
            }
            
            const personId = document.getElementById('personId').value.trim();
            if (!personId) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ID ng∆∞·ªùi th·ª±c hi·ªán!');
                return;
            }
            
            document.getElementById('recordBtn').disabled = true;
            
            const countdownEl = document.getElementById('countdown');
            const instructionsEl = document.getElementById('instructions');
            countdownEl.style.display = 'block';
            
            // Countdown 3s
            for (let i = 3; i > 0; i--) {
                countdownEl.textContent = i;
                instructionsEl.innerHTML = `<strong style="font-size: 1.5em;">Chu·∫©n b·ªã... ${i}</strong>`;
                await sleep(1000);
            }
            
            countdownEl.textContent = 'GHI!';
            countdownEl.style.color = '#f56565';
            instructionsEl.innerHTML = `<strong style="font-size: 2em; color: #f56565;">üìπ ƒêANG GHI!</strong>`;
            
            // Start recording
            isRecording = true;
            currentFrames = [];
            
            // Record for 1 second
            await sleep(1000);
            
            // Stop
            isRecording = false;
            countdownEl.style.display = 'none';
            countdownEl.style.color = '#667eea';
            instructionsEl.innerHTML = `<strong>ƒêang thu: ${selectedGesture}</strong>`;
            
            // Save
            if (currentFrames.length >= 25) {
                saveSample(selectedGesture, personId);
            } else {
                alert(`‚ö†Ô∏è Ch·ªâ ${currentFrames.length} frames. C·∫ßn √≠t nh·∫•t 25. Th·ª≠ l·∫°i!`);
            }
            
            document.getElementById('recordBtn').disabled = false;
        }
        
        // Capture frame
        function captureFrame(landmarks) {
            const frame = {
                landmarks: landmarks.map(lm => ({
                    x: lm.x,
                    y: lm.y,
                    z: lm.z
                }))
            };
            currentFrames.push(frame);
        }
        
        // Save sample
        function saveSample(gestureName, personId) {
            sequenceCount++;
            
            // Pad to 30 frames
            let frames = currentFrames.slice();
            while (frames.length < 30) {
                frames.push(frames[frames.length - 1]);
            }
            frames = frames.slice(0, 30);
            
            const sample = {
                gesture: gestureName,
                person_id: personId,
                sequence_id: sequenceCount,
                sequences: [{
                    frames: frames,
                    duration_ms: 1000
                }],
                timestamp: new Date().toISOString()
            };
            
            allSamples.push(sample);
            updateSamplesList();
            updateProgress();
            document.getElementById('downloadBtn').disabled = false;
            
            const target = parseInt(document.getElementById('targetSamples').value);
            if (allSamples.length >= target) {
                alert(`üéâ Ho√†n th√†nh ${target} m·∫´u! Nh·∫•n Download.`);
            }
        }
        
        // Update samples list
        function updateSamplesList() {
            const listEl = document.getElementById('samplesList');
            
            if (allSamples.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Ch∆∞a c√≥ m·∫´u...</p>';
                return;
            }
            
            listEl.innerHTML = allSamples.map((sample, idx) => `
                <div class="sample-item completed">
                    <span><strong>#${idx + 1}:</strong> ${sample.gesture} - ${sample.person_id}</span>
                    <span style="font-size: 12px; color: #28a745;">
                        ‚úì ${sample.sequences[0].frames.length} frames
                    </span>
                </div>
            `).join('');
        }
        
        // Update progress
        function updateProgress() {
            const target = parseInt(document.getElementById('targetSamples').value);
            const current = allSamples.length;
            const percentage = Math.min((current / target) * 100, 100);
            
            document.getElementById('currentSamples').textContent = current;
            document.getElementById('targetDisplay').textContent = target;
            document.getElementById('progressFill').style.width = percentage + '%';
        }
        
        // Download data
        function downloadData() {
            if (allSamples.length === 0) {
                alert('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu!');
                return;
            }
            
            const personId = document.getElementById('personId').value.trim() || 'person';
            
            // G·ªôp t·∫•t c·∫£ 100 m·∫´u v√†o chung 1 m·∫£ng 'sequences'
            const combinedData = {
                gesture: selectedGesture,
                person_id: personId,
                total_samples: allSamples.length,
                sequences: allSamples.map(sample => sample.sequences[0]), // L·∫•y l√µi data c·ªßa t·ª´ng m·∫´u g·ªôp l·∫°i
                timestamp: new Date().toISOString()
            };
            
            // √âp th√†nh 1 file JSON duy nh·∫•t
            const dataStr = JSON.stringify(combinedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            // T√™n file t·∫£i v·ªÅ s·∫Ω c√≥ d·∫°ng: ƒêau_person1_100samples.json
            a.download = `${selectedGesture}_${personId}_${allSamples.length}samples.json`; 
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ T·∫¢I TH√ÄNH C√îNG!\n\nƒê√£ g·ªôp ${allSamples.length} m·∫´u v√†o 1 file JSON duy nh·∫•t.\nB·∫°n ch·ªâ c·∫ßn n√©m ƒë√∫ng 1 file n√†y v√†o th∆∞ m·ª•c "dataset/${selectedGesture}/" l√† xong. Code Python s·∫Ω t·ª± ƒë·ªông ƒë·ªçc ƒë∆∞·ª£c h·∫øt!`);
        }
        
        // Reset
        function resetData() {
            if (allSamples.length > 0 && !confirm('‚ö†Ô∏è X√≥a t·∫•t c·∫£ d·ªØ li·ªáu?')) {
                return;
            }
            
            allSamples = [];
            sequenceCount = 0;
            currentFrames = [];
            selectedGesture = '';
            
            document.querySelectorAll('.gesture-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            document.getElementById('gestureName').value = '';
            updateSamplesList();
            updateProgress();
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('instructions').innerHTML = 'üëÜ Ch·ªçn k√Ω hi·ªáu v√† b·∫Øt ƒë·∫ßu';
        }
        
        // Sleep helper
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // MediaPipe HAND_CONNECTIONS - CH√çNH TH·ª®C
        const HAND_CONNECTIONS = [
            [0, 1], [1, 2], [2, 3], [3, 4],           // Thumb
            [0, 5], [5, 6], [6, 7], [7, 8],           // Index
            [5, 9], [9, 10], [10, 11], [11, 12],      // Middle
            [9, 13], [13, 14], [14, 15], [15, 16],    // Ring
            [13, 17], [0, 17], [17, 18], [18, 19], [19, 20]  // Pinky
        ];
        
        // Drawing functions - S·ª¨ D·ª§NG MEDIAPIPE DRAWING UTILS
        function drawConnectors(ctx, landmarks, connections, style) {
            ctx.strokeStyle = style.color;
            ctx.lineWidth = style.lineWidth;
            
            connections.forEach(([start, end]) => {
                const startPoint = landmarks[start];
                const endPoint = landmarks[end];
                
                ctx.beginPath();
                ctx.moveTo(startPoint.x * canvas.width, startPoint.y * canvas.height);
                ctx.lineTo(endPoint.x * canvas.width, endPoint.y * canvas.height);
                ctx.stroke();
            });
        }
        
        function drawLandmarks(ctx, landmarks, style) {
            landmarks.forEach(landmark => {
                ctx.fillStyle = style.color;
                ctx.beginPath();
                ctx.arc(
                    landmark.x * canvas.width,
                    landmark.y * canvas.height,
                    style.radius,
                    0,
                    2 * Math.PI
                );
                ctx.fill();
            });
        }
        
        // Update target on change
        document.getElementById('targetSamples').addEventListener('change', updateProgress);
    </script>
</body>
</html>
